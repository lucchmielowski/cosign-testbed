# Verify image that was signed with a github attestation
apiVersion: policies.kyverno.io/v1
kind: ImageValidatingPolicy
metadata:
  name: verify-github-attestations-private
spec:
  validationActions: [Deny]
  webhookConfiguration:
    timeoutSeconds: 15
  failurePolicy: Fail
  matchConstraints:
    resourceRules:
      - apiGroups: [""]
        apiVersions: ["v1"]
        resources: ["pods"]
        operations: ["CREATE", "UPDATE"]
  matchImageReferences:
    - glob: "ghcr.io/lucchmielowski/kyverno-cosign-testbed-private:*"
  validationConfigurations:
    mutateDigest: false
    verifyDigest: false

  # Define the attestation you want to verify
  attestations:
    - name: slsa
      intoto:
        type: https://slsa.dev/provenance/v1

  # Define the attestor (how to verify)
  credentials:
    allowInsecureRegistry: false
    providers:
      - "default"
    secrets:
      - "ghcr-secret"
  attestors:
    - name: cosign
      cosign:
        keyless:
          identities:
            - subject: "https://github.com/lucchmielowski/kyverno-cosign-testbed/.github/workflows/ci.yml@refs/heads/main"
              issuer: "https://token.actions.githubusercontent.com"
        ctlog:
          url: "https://rekor.sigstore.dev"

  # Validation expressions
  validations:
    - expression: >-
        images.containers.map(image,
          verifyAttestationSignatures(image, attestations.slsa, [attestors.cosign])
        ).all(e, e > 0)
      message: "Failed to verify SLSA provenance attestation"
